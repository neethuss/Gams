<%- include('nav') -%>

    <div class="container-fluid py-4" style="font-family: auto;">
        <div class="row">
            <div class="col-12">
                <div class="card my-4">
                    <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                        <div class="bg-gradient-danger shadow-primary border-radius-lg pt-4 pb-3">
                            <h6 class="text-white text-capitalize ps-3">UserManagement</h6>

                        </div>
                    </div>
                    <div class="card-body px-0 pb-2">
                        <div class="table-responsive p-0">
                            <table class="table align-items-center mb-0">
                                <thead>
                                    <tr style="text-align: center;">
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                            Id</th>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                            Name</th>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                            Email</th>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                            Phone</th>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% users.forEach((users,i)=>{%>


                                        <tr style="text-align: center">
                                            <td>
                                                <%= i+1 %>
                                            </td>
                                            <td>
                                                <%= users.username %>
                                            </td>
                                            <td>
                                                <%= users.email %>
                                            </td>
                                            <td>
                                                <%= users.phone %>
                                            </td>
                                            <td>
                                                <button
                                                    class="btn block-btn <%= users.isBlocked ? 'btn-success' : 'btn-danger' %>"
                                                    data-email="<%= users.email %>"
                                                    data-username="<%= users.username %>"
                                                    data-isblocked="<%= users.isBlocked %>">
                                                    <%= users.isBlocked ? 'Unblock' : 'Block' %>
                                                </button>

                                            </td>

                                        </tr>
                                        <%}) %>
                                </tbody>
                            </table>

                            <div class="pagination"
                                style="display: flex; align-items: center; justify-content: center;">
                                <nav aria-label="Page navigation" class="pagination-container"
                                    style="margin-top: 30px;">
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item <%= page == 1 ? 'disabled' : '' %>">
                                            <a class="page-link" href="?page=<%= page - 1 %>" aria-label="Previous">
                                                <span aria-hidden="true"><i class="icon-long-arrow-left"></i></span>Prev
                                            </a>
                                        </li>

                                        <% for (let i=1; i <=totalPages; i++) { %>
                                            <li class="page-item <%= page == i ? 'active' : '' %>">
                                                <a class="page-link" href="?page=<%= i %>">
                                                    <%= i %>
                                                </a>
                                            </li>
                                            <% } %>

                                                <li class="page-item <%= page == totalPages ? 'disabled' : '' %>">
                                                    <a class="page-link" href="?page=<%= page + 1 %>" aria-label="Next">
                                                        Next <span aria-hidden="true"><i
                                                                class="icon-long-arrow-right"></i></span>
                                                    </a>
                                                </li>
                                    </ul>
                                </nav>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmBlockModal" tabindex="-1" role="dialog" aria-labelledby="confirmBlockModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmBlockModalLabel">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="modalMessage">Are you sure you want to block this user?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmBlockBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        const successMsg = '<%= successMsg.join("<br>") %>';

        if (successMsg) {
            Toastify({
                text: successMsg,
                duration: 3000,
                className: 'toastify-success',
                gravity: "top",
                position: "center",
                backgroundColor: 'red',
            }).showToast();
        }
    </script>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            let currentButton = null;

            // When block/unblock button is clicked
            $('.block-btn').click(function () {
                currentButton = $(this);
                const isBlocked = currentButton.data('isblocked');
                const username = currentButton.data('username');

                // Update modal text based on current state
                if (isBlocked) {
                    $('#modalMessage').text(`Are you sure you want to unblock user "${username}"?`);
                } else {
                    $('#modalMessage').text(`Are you sure you want to block user "${username}"?`);
                }

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('confirmBlockModal'));
                modal.show();
            });

            // When confirmation button in modal is clicked
            $('#confirmBlockBtn').click(function () {
                if (currentButton) {
                    const email = currentButton.data('email');

                    $.ajax({
                        url: '/admin/blockUser',
                        method: 'PATCH',
                        contentType: 'application/json',
                        data: JSON.stringify({ email: email }),
                        success: function () {
                            // Read the current state from button
                            let isBlocked = currentButton.data('isblocked');

                            // Toggle the value
                            isBlocked = !isBlocked;

                            // Update UI
                            if (isBlocked) {
                                currentButton.removeClass('btn-danger').addClass('btn-success').text('Unblock');
                            } else {
                                currentButton.removeClass('btn-success').addClass('btn-danger').text('Block');
                            }

                            // Update data attribute
                            currentButton.data('isblocked', isBlocked);

                            // Close the modal
                            const modalElement = document.getElementById('confirmBlockModal');
                            const modal = bootstrap.Modal.getInstance(modalElement);
                            modal.hide();
                         
                        // Show success message
                        Toastify({
                            text: `User successfully ${isBlocked ? 'blocked' : 'unblocked'}`,
                            duration: 3000,
                            className: 'toastify-success',
                            gravity: "top",
                            position: "center",
                            backgroundColor: '#4caf50',
                        }).showToast();
                        },
                        error: function () {
                            alert('Error: Could not update user block status.');

                            // Close the modal
                            const modalElement = document.getElementById('confirmBlockModal');
                            const modal = bootstrap.Modal.getInstance(modalElement);
                            modal.hide();
                        }
                    });
                }
            });
        });
    </script>

    <style>
        .table {
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        .table tbody tr {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
        }

        
        .table tbody td {
            padding: 12px 15px;
            vertical-align: middle;
            border-top: none;
            background-color: #fff;
        }

        .table tbody tr td:first-child {
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }

        .table tbody tr td:last-child {
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .table thead th {
            padding: 12px 15px;
            border-bottom: none;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .block-btn {
            border-radius: 20px;
            padding: 5px 15px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .block-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #ff5722);
            border: none;
        }

        .btn-success {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            border: none;
        }

        .modal-content {
            border-radius: 10px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            border-bottom: 1px solid #f1f1f1;
            background-color: #f8f9fa;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .modal-footer {
            border-top: 1px solid #f1f1f1;
        }

        #confirmBlockBtn {
            background: linear-gradient(45deg, #f44336, #ff5722);
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            transition: all 0.3s ease;
        }

        #confirmBlockBtn:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #e9ecef;
            color: #495057;
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background-color: #dee2e6;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .pagination .page-link {
            border-radius: 20px;
            margin: 0 3px;
            color: #495057;
            transition: all 0.3s ease;
        }

        .pagination .page-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
        }

        .pagination .page-item.active .page-link {
            background: linear-gradient(45deg, #f44336, #ff5722);
            border-color: transparent;
        }

        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .card-header {
            padding: 0;
        }
    </style>




    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>


    </body>



    </html>