<%- include('nav') -%>

    <div class="container-fluid py-4" style="font-family: auto;">
        <div class="row">
            <div class="col-12">
                <div class="card my-4">
                    <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                        <div
                            class="bg-gradient-danger shadow-primary border-radius-lg pt-4 pb-3 d-flex justify-content-between">
                            <h6 class="text-white text-capitalize ps-3">Edit Product</h6>
                        </div>
                    </div>

                    <!-- Display Flash Messages -->
                    <% if (locals.success_msg) { %>
                        <div class="alert alert-success alert-dismissible fade show mx-3 mt-3" role="alert">
                            <%= success_msg %>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"
                                    aria-label="Close"></button>
                        </div>
                        <% } %>

                            <% if (locals.error_msg) { %>
                                <div class="alert alert-danger alert-dismissible fade show mx-3 mt-3" role="alert">
                                    <%= error_msg %>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"
                                            aria-label="Close"></button>
                                </div>
                                <% } %>

                                    <div class="card-body px-3 pb-2">
                                        <form action="/admin/editProduct/<%= product._id %>" method="patch"
                                            enctype="multipart/form-data" id="editProductForm"
                                            style="display: flex;flex-direction: column;align-items: center;">

                                            <div class="mb-3">
                                                <label for="productName" class="form-label">Product Name</label>
                                                <input type="text" class="form-control" id="productName"
                                                    name="productName" value="<%= locals.product.product_name %>"
                                                    style="border: 1px solid #ced4da; width: 430px;text-align: center;">
                                                <span id="nameError" style="color: red;"></span>
                                            </div>

                                            <div class="mb-3">
                                                <label for="productCategory" class="form-label">Product Category</label>
                                                <select class="form-select" id="productCategory" name="productCategory"
                                                    style="border: 1px solid #ced4da; width: 430px;text-align: center;"
                                                    required>
                                                    <% 
                                                        currentCategoryId=product.product_category.toString();
                                                        categories.forEach(category=> {
                                                        let selected = (category._id.toString() === currentCategoryId) ?
                                                        "selected" : "";
                                                        %>
                                                        <option value="<%= category._id %>" <%=selected %>>
                                                            <%= category.category_name %>
                                                        </option>
                                                        <% }); %>
                                                </select>
                                                <span id="categoryError" style="color: red;"></span>
                                            </div>

                                            <div class="mb-3">
                                                <label for="productPrice" class="form-label">Product Price</label>
                                                <input type="number" class="form-control" id="productPrice"
                                                    name="productPrice" value="<%= locals.product.product_price %>"
                                                    step="0.01" min="0.01"
                                                    style="border: 1px solid #ced4da; width: 430px;text-align: center;">
                                                <span id="priceError" style="color: red;"></span>
                                            </div>

                                            <div class="mb-3">
                                                <label for="productStock" class="form-label">Product Stock</label>
                                                <input type="number" class="form-control" id="productStock"
                                                    name="productStock" value="<%= locals.product.product_stock %>"
                                                    min="0"
                                                    style="border: 1px solid #ced4da; width: 430px;text-align: center;">
                                                <span id="stockError" style="color: red;"></span>
                                            </div>

                                            <div class="mb-3">
                                                <label for="productDescription" class="form-label">Product Description</label>
                                                <input class="form-control" id="productDescription"
                                                    name="productDescription" value="<%= locals.product.product_description %>"
                                                    min="0"
                                                    style="border: 1px solid #ced4da; width: 430px;text-align: center;">
                                                <span id="descriptionError" style="color: red;"></span>
                                            </div>


                                            <div class="mb-3">
                                                <label for="productImage" class="form-label">Product Images</label>
                                                <div id="existing-images"
                                                    style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 15px;">
                                                    <% if (product.product_image && product.product_image.length> 0) {
                                                        %>
                                                        <% product.product_image.forEach((element, index)=> { %>
                                                            <div class="image-container" style="position: relative;"
                                                                data-index="<%= index %>"
                                                                data-product-id="<%= product._id %>">
                                                                <img class="img-fluid"
                                                                    style="width: 90px; height: 90px; object-fit: cover; border-radius: 5px;"
                                                                    src="/uploads/<%= element %>" alt="Product image" />
                                                                <button type="button" class="delete-image-btn"
                                                                    style="position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.7); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; padding: 0;">Ã—</button>
                                                            </div>
                                                            <% }) %>
                                                                <% } else { %>
                                                                    <p class="text-muted">No images available.</p>
                                                                    <% } %>
                                                </div>

                                                <input multiple type="file" class="form-control" id="productImage"
                                                    name="productImage"
                                                    accept="image/jpeg, image/png, image/gif, image/*"
                                                    style="border: 1px solid #ced4da; width: 430px; text-align: center;"
                                                    onchange="previewImages(event)">
                                                <span id="imageError" style="color: red;"></span>
                                                <div id="image-preview"
                                                    style="display: flex; flex-wrap: wrap; margin-top: 10px;"></div>
                                            </div>

                                            <button type="submit" class="btn btn-success">Update Product</button>
                                        </form>
                                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Delete Image -->
    <div class="modal fade" id="deleteImageModal" tabindex="-1" aria-labelledby="deleteImageModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteImageModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this image?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteImage">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            // Form validation
            $("#editProductForm").submit(function (event) {
                event.preventDefault();

                // Reset error messages
                $("#nameError, #categoryError, #priceError, #stockError, #imageError").text("");

                let isValid = true;

                // Product name validation
                const productName = $("#productName").val().trim();
                if (!productName) {
                    $("#nameError").text("Product name is required");
                    isValid = false;
                }

                // Category validation
                const category = $("#productCategory").val();
                if (!category) {
                    $("#categoryError").text("Please select a category");
                    isValid = false;
                }

                // Price validation
                const price = $("#productPrice").val().trim();
                if (!price) {
                    $("#priceError").text("Product price is required");
                    isValid = false;
                } else if (parseFloat(price) <= 0) {
                    $("#priceError").text("Price must be greater than zero");
                    isValid = false;
                }

                // Stock validation
                const stock = $("#productStock").val().trim();
                if (!stock) {
                    $("#stockError").text("Product stock is required");
                    isValid = false;
                } else if (parseInt(stock) < 0) {
                    $("#stockError").text("Stock cannot be negative");
                    isValid = false;
                }

                const productDescription = $("#productDescription").val().trim();
                if (!productDescription) {
                    $("#descriptionError").text("Product description is required");
                    isValid = false;
                }

                // Image validation - Check if there will be any images after submission
                const existingImages = $("#existing-images .image-container").length;
                const newImages = $("#productImage")[0].files.length;

                if (existingImages === 0 && newImages === 0) {
                    $("#imageError").text("At least one product image is required");
                    isValid = false;
                }

                if (isValid) {
                    this.submit();
                } else {
                    const firstError = $(".form-control + span, .form-select + span").filter(function () {
                        return $(this).text() !== "";
                    }).first();

                    if (firstError.length) {
                        $('html, body').animate({
                            scrollTop: firstError.offset().top - 100
                        }, 200);
                    }
                }
            });

            // Handle delete image - using AJAX
            let imageToDelete = null;

            $(".delete-image-btn").click(function () {
                const container = $(this).closest(".image-container");
                imageToDelete = {
                    index: container.data("index"),
                    productId: container.data("product-id"),
                    container: container
                };

                $("#deleteImageModal").modal("show");
            });

            $("#confirmDeleteImage").click(function () {
                if (!imageToDelete) return;


                $.ajax({
                    url: `/admin/deleteProductImage/${imageToDelete.index}/${imageToDelete.productId}`,
                    method: "DELETE",
                    success: function (response) {
                        if (response.success) {

                            imageToDelete.container.remove();


                            Toastify({
                                text: response.message,
                                duration: 3000,
                                gravity: "top",
                                position: "center",
                                backgroundColor: "#4caf50",
                            }).showToast();


                            if ($("#existing-images .image-container").length === 0) {
                                $("#existing-images").html('<p class="text-muted">No images available. Please upload at least one image.</p>');
                            }
                        } else {

                            Toastify({
                                text: response.message,
                                duration: 3000,
                                gravity: "top",
                                position: "center",
                                backgroundColor: "#f44336",
                            }).showToast();
                        }

                        // Close modal
                        $("#deleteImageModal").modal("hide");
                    },
                    error: function (xhr) {
                        let errorMessage = "Error deleting image";
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }

                        Toastify({
                            text: errorMessage,
                            duration: 3000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "#f44336",
                        }).showToast();

                        $("#deleteImageModal").modal("hide");
                    }
                });
            });
        });

        function previewImages(event) {
            const previewContainer = document.getElementById('image-preview');
            previewContainer.innerHTML = '';

            const files = event.target.files;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                reader.onload = function (e) {
                    const previewImage = document.createElement('img');
                    previewImage.style.width = '90px';
                    previewImage.style.height = '90px';
                    previewImage.style.objectFit = 'cover';
                    previewImage.style.borderRadius = '5px';
                    previewImage.style.margin = '10px';
                    previewImage.src = e.target.result;

                    previewContainer.appendChild(previewImage);
                }

                reader.readAsDataURL(file);
            }
        }
    </script>
    </body>

    </html>